<!DOCTYPE html>
<html lang="en">

<head>
  <title>Janne Lavila - Software Engineer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/normalize.css?ver=11" />
  <link rel="stylesheet" href="css/main.css?ver=11" />
  <link rel="stylesheet" href="css/photography.css?ver=11" />
  <script type="module" src="js/index.js?ver=11"></script>
</head>

<body>
  <nav>
    <nav-content currentpage="home">
      <div class="loading-bar"></div>
    </nav-content>
  </nav>
  <main>
    <section>
      <article>
        <header></header>
        <section>
          <picture class="article-picture">
            <source srcset="img/640-foo.webp 640w, img/1600-foo.webp 1600w, img/1920-foo.webp 1920w"
              sizes="(max-width: 640px) 640px, (max-width: 1600px) 1600px, 1920px" />
            <source
              srcset="img/640-portrait-foo.webp 640w, img/1600-portrait-foo.webp 1600w, img/1920-portrait-foo.webp 1920w"
              sizes="(max-width: 640px) 640px, (max-width: 1600px) 1600px, 1920px" />
            <img src="img/640-foo.webp" loading="lazy" />
          </picture>
          <picture class="background-image displayed fadein">
            <img src="img/1920-appletreeflower.webp" loading="lazy" />
          </picture>
        </section>
        <footer></footer>
      </article>
    </section>

    <section>
      <article>
        <header></header>
        <section>
          <picture class="article-picture">
            <source srcset="img/640-portrait-foo.webp" sizes="(max-width: 639px)" />
            <source srcset="img/640-foo.webp" sizes="(min-width: 640px)" />
            <img src="img/640-foo.webp" loading="lazy" />
          </picture>
          <picture class="background-image displayed">
            <img src="img/1920-velvetflower.webp" loading="lazy" />
          </picture>
        </section>
        <footer></footer>
      </article>
    </section>

    <section>
      <article>
        <header></header>
        <section>
          <picture class="background-image">
            <img src="img/1920-amanita.webp" loading="lazy" />
          </picture>
        </section>
        <footer></footer>
      </article>
    </section>

    <section>
      <article>
        <header></header>
        <section>
          <picture class="background-image">
            <img src="img/1920-snowapple.webp" loading="lazy" />
          </picture>
        </section>
        <footer></footer>
      </article>
    </section>
  </main>

  <script>
    const supportsLazy = 'loading' in HTMLImageElement.prototype
    const observer = new IntersectionObserver(async (entries) => {
      const intersectingEntry = entries.find(entry => entry.isIntersecting)
      if (!intersectingEntry) return

      const img = intersectingEntry.target.querySelector("img")
      if (supportsLazy && !img.complete) {
        await new Promise(resolve => {
          function listen() {
            img.removeEventListener("load", listen)
            resolve()
          }
          img.addEventListener("load", listen)
        })
      }

      fadeOutSurroundingBackgroundImages(intersectingEntry)

      fadeInCurrentBackground(intersectingEntry)

      setNextToBeDisplayed(intersectingEntry)

    }, { root: document.body, threshold: .8 })

    document.querySelectorAll("main > section").forEach(article => observer.observe(article))

    /**
    * @param intersectingEntry {IntersectionObserverEntry}
    */
    function fadeOutSurroundingBackgroundImages(intersectingEntry) {
      const prevSection = intersectingEntry.target.previousElementSibling
      const nextSection = intersectingEntry.target.nextElementSibling
      if (prevSection instanceof HTMLElement) {
        const prevPicture = prevSection.querySelector(".background-image")
        prevPicture.classList.replace("fadein", "fadeout")
      }
      if (nextSection instanceof HTMLElement) {
        const prevPicture = nextSection.querySelector(".background-image")
        prevPicture.classList.replace("fadein", "fadeout")
      }
    }

    /**
    * @param intersectingEntry {IntersectionObserverEntry}
    */
    function fadeInCurrentBackground(intersectingEntry) {
      const backgroundPicture = intersectingEntry.target.querySelector(".background-image")
      backgroundPicture.classList.remove("fadeout")
      backgroundPicture.classList.add("fadein")
    }

    /**
    * The pictures are set to display: none to leverage the browser's lazy loading
    * capabilities. Set the next picture to be displayed and the browser should load it
    * while the current is being viewed
    *
    * @param intersectingEntry {IntersectionObserverEntry}
    */
    function setNextToBeDisplayed(intersectingEntry) {
      const nextSection = intersectingEntry.target.nextElementSibling
      if (nextSection instanceof HTMLElement) {
        const nextBackgroundPicture = nextSection.querySelector(".background-image")
        nextBackgroundPicture.classList.add("displayed")
      }
    }
  </script>
</body>

</html>